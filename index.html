<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart PHC Medicine Store Dashboard</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin:0;
    background: linear-gradient(135deg, #d0f0f0, #b0e5d8);
    color: #333;
    background-image:
          repeating-linear-gradient(
            45deg,
            rgba(255,255,255,0.15),
            rgba(255,255,255,0.15) 10px,
            transparent 10px,
            transparent 20px
          ),
          linear-gradient(135deg, #d0f0f0, #b0e5d8);
  }
  header {
    background: linear-gradient(90deg, #0077b6, #00b894);
    color: white;
    padding: 15px 20px;
    text-align: center;
    font-size: 1.5em;
    font-weight: bold;
  }
  nav {
    display: flex;
    background: #e0f2f1;
    overflow-x: auto;
    border-bottom: 2px solid #ccc;
  }
  nav button {
    flex: 1;
    padding: 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 1em;
    transition: background 0.3s;
  }
  nav button.active {
    background: #b2dfdb;
    font-weight: bold;
    border-bottom: 3px solid #0077b6;
  }
  section {
    padding: 20px;
    display: none;
  }
  section.active {
    display: block;
  }
  .card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  .btn {
    background: #00b894;
    color: white;
    border: none;
    padding: 8px 12px;
    margin: 3px;
    border-radius: 5px;
    cursor: pointer;
  }
  .btn:hover {
    background: #019874;
  }
  .search-bar input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  .table-container {
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }
  th {
    background: #0077b6;
    color: white;
  }
  .alert {
    padding: 10px;
    background: #ffcccc;
    border: 1px solid #ff4d4d;
    color: #b30000;
    border-radius: 5px;
    margin-bottom: 10px;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>

<header>💊 Smart PHC Medicine Store Dashboard</header>

<nav>
  <button class="tab-btn active" data-tab="stock">Medicine Stock</button>
  <button class="tab-btn" data-tab="expiry">Near Expiry Alerts</button>
  <button class="tab-btn" data-tab="scanner">QR Code Scanner</button>
  <button class="tab-btn" data-tab="reports">Reports</button>
  <button class="tab-btn" data-tab="eaushadhi">e-Aushadhi Usage</button>
</nav>

<!-- Medicine Stock Tab -->
<section id="stock" class="active">
  <div class="card">
    <h3>📂 Upload & Search Medicines</h3>
    <input type="file" id="excelFile" accept=".xlsx, .xls" class="btn" />
    <div class="search-bar" style="margin-top:10px;">
      <input type="text" id="searchInput" placeholder="🔍 Search medicine by name..." />
    </div>
    <select id="rackFilter" class="btn" style="margin-top:10px;">
      <option value="">All Racks</option>
    </select>
  </div>
  <div class="card table-container">
    <table id="medicineTable">
      <thead>
        <tr>
          <th>Medicine Name</th>
          <th>Rack</th>
          <th>Quantity</th>
          <th>Expiry Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- Near Expiry Alerts Tab -->
<section id="expiry">
  <div class="card">
    <h3>⚠ Near Expiry Medicines (Within 30 Days)</h3>
    <div id="expiryAlerts"></div>
  </div>
</section>

<!-- QR Code Scanner Tab -->
<section id="scanner">
  <div class="card">
    <h3>📷 QR Code Scanner</h3>
    <button id="startScanner" class="btn">Start Camera Scan</button>
    <video id="qrVideo" width="300" height="200" style="display:none; border:1px solid #ccc;"></video>
    <p id="qrResult"></p>
  </div>
</section>

<!-- Reports Tab -->
<section id="reports">
  <div class="card">
    <h3>📊 Export Reports</h3>
    <button id="exportExcel" class="btn">Export to Excel</button>
    <button id="exportPDF" class="btn">Export to PDF</button>
  </div>
</section>

<!-- e-Aushadhi Usage Tab -->
<section id="eaushadhi">
  <div class="card">
    <h3>📂 Upload e-Aushadhi Stock-in-Hand Excel</h3>
    <input type="file" id="eaushadhiExcel" accept=".xlsx, .xls" class="btn" />
    <div class="search-bar" style="margin-top:10px;">
      <input type="text" id="eaushadhiSearch" placeholder="🔍 Search medicine..." />
    </div>
    <div style="margin-top:20px;">
      <canvas id="usageChart" width="600" height="300"></canvas>
    </div>
  </div>
</section>

<script>
  // Helper: Convert Excel serial date to JS Date
  function excelDateToJSDate(serial) {
    if (typeof serial !== 'number') return null;
    const utc_days = Math.floor(serial - 25569);
    const utc_value = utc_days * 86400;
    const date_info = new Date(utc_value * 1000);
    return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate());
  }

  // Parse date from string dd/mm/yyyy or excel serial number
  function parseDate(raw) {
    if (!raw) return null;
    if (typeof raw === 'number') return excelDateToJSDate(raw);
    if (typeof raw === 'string') {
      const parts = raw.split('/');
      if (parts.length === 3) {
        // dd/mm/yyyy
        return new Date(parts[2], parts[1] - 1, parts[0]);
      }
      // fallback: try Date parse
      const d = new Date(raw);
      if (!isNaN(d)) return d;
    }
    return null;
  }

  // Tabs switching
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");
      if(btn.dataset.tab === 'expiry') {
        updateExpiryAlerts();
      }
    });
  });

  // Global medicine data array
  let medicines = [];
  let racks = new Set();

  // Load Excel for Medicine Stock
  document.getElementById('excelFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(evt) {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

      medicines = jsonData.map(row => {
        return {
          name: row['Medicine Name'] || row['Medicine'] || row['Item Name'] || '',
          rack: row['Rack'] || row['Rack Code'] || '',
          quantity: Number(row['Quantity'] || row['Quantity Remaining'] || 0),
          expiry: parseDate(row['Expiry Date'] || row['Expiry'] || '')
        };
      }).filter(med => med.name && !isNaN(med.quantity));

      // Extract unique racks
      racks = new Set(medicines.map(med => med.rack).filter(r => r));

      // Update rack filter dropdown
      const rackFilter = document.getElementById('rackFilter');
      rackFilter.innerHTML = '<option value="">All Racks</option>';
      Array.from(racks).sort().forEach(rack => {
        const opt = document.createElement('option');
        opt.value = rack;
        opt.textContent = rack;
        rackFilter.appendChild(opt);
      });

      renderMedicineTable();
    };
    reader.readAsArrayBuffer(file);
  });

  // Render medicine table
  function renderMedicineTable() {
    const tbody = document.querySelector('#medicineTable tbody');
    tbody.innerHTML = '';
    medicines.forEach(med => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${med.name}</td>
        <td>${med.rack}</td>
        <td>${med.quantity}</td>
        <td>${med.expiry ? med.expiry.toISOString().slice(0,10) : ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Search & Filter
  document.getElementById('searchInput').addEventListener('input', filterTable);
  document.getElementById('rackFilter').addEventListener('change', filterTable);

  function filterTable() {
    const searchVal = document.getElementById('searchInput').value.toLowerCase();
    const rackVal = document.getElementById('rackFilter').value;
    const rows = document.querySelectorAll('#medicineTable tbody tr');

    rows.forEach(row => {
      const name = row.cells[0].textContent.toLowerCase();
      const rack = row.cells[1].textContent;
      const matchesSearch = name.includes(searchVal);
      const matchesRack = rackVal === '' || rack === rackVal;
      row.style.display = matchesSearch && matchesRack ? '' : 'none';
    });
  }

  // Update expiry alerts tab
  function updateExpiryAlerts() {
    const alertDiv = document.getElementById('expiryAlerts');
    alertDiv.innerHTML = '';

    const now = new Date();
    const nearExpiryMeds = medicines.filter(med => {
      if (!med.expiry) return false;
      const diffDays = Math.ceil((med.expiry - now) / (1000*60*60*24));
      return diffDays >= 0 && diffDays <= 30;
    });

    if(nearExpiryMeds.length === 0) {
      alertDiv.innerHTML = '<p>No medicines near expiry in next 30 days.</p>';
      return;
    }

    nearExpiryMeds.forEach(med => {
      const div = document.createElement('div');
      div.className = 'alert';
      div.textContent = `${med.name} - Expires on ${med.expiry.toISOString().slice(0,10)}`;
      alertDiv.appendChild(div);
    });
  }

  // QR Scanner logic: Open camera on button click
  const video = document.getElementById('qrVideo');
  const qrResult = document.getElementById('qrResult');
  let stream;

  document.getElementById('startScanner').addEventListener('click', async () => {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert("Camera API not supported in this browser.");
      return;
    }

    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
      video.style.display = 'block';
      video.play();
      qrResult.textContent = "Camera started. Point to a QR code.";
    } catch (err) {
      alert("Camera access denied or not available.");
      qrResult.textContent = "";
      console.error(err);
    }
  });

  // Reports export placeholders
  document.getElementById('exportExcel').addEventListener('click', () => {
    alert("Export to Excel functionality will be implemented here.");
  });
  document.getElementById('exportPDF').addEventListener('click', () => {
    alert("Export to PDF functionality will be implemented here.");
  });

  // e-Aushadhi Stock-in-Hand Usage Tab
  let eaushadhiData = [];
  let filteredEauData = [];
  let usageChart;
  const eaushadhiSearch = document.getElementById('eaushadhiSearch');
  const usageChartCtx = document.getElementById('usageChart').getContext('2d');

  document.getElementById('eaushadhiExcel').addEventListener('change', function(e){
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(event){
      const data = new Uint8Array(event.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const firstSheet = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheet];

      let jsonData = XLSX.utils.sheet_to_json(worksheet, {defval:''});

      // Adjust column keys as per your Excel headers
      eaushadhiData = jsonData.map(row => ({
        medicine: row['Medicine Name'] || row['Medicine'] || row['Item Name'] || '',
        quantity: Number(row['Quantity Remaining'] || row['Qty Remaining'] || row['Quantity'] || 0),
        date: row['Date'] || row['Month'] || '', // optional
      })).filter(r => r.medicine && !isNaN(r.quantity));

      filteredEauData = [...eaushadhiData];
      renderChart();
    }
    reader.readAsArrayBuffer(file);
  });

  eaushadhiSearch.addEventListener('input', function(){
    const val = this.value.toLowerCase();
    filteredEauData = eaushadhiData.filter(d => d.medicine.toLowerCase().includes(val));
    renderChart();
  });

  function renderChart(){
    if(usageChart) usageChart.destroy();

    if(filteredEauData.length === 0){
      usageChartCtx.clearRect(0, 0, 600, 300);
      return;
    }

    // Aggregate usage by medicine, summing quantities
    const usageMap = {};
    filteredEauData.forEach(d => {
      usageMap[d.m

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart PHC Medicine Store Dashboard</title>

<!-- External libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background-image:
      repeating-linear-gradient(45deg, rgba(255,255,255,0.15), rgba(255,255,255,0.15) 10px, transparent 10px, transparent 20px),
      linear-gradient(135deg, #d0f0f0, #b0e5d8);
    color: #333;
}
header {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(90deg, #0077b6, #00b894);
    color: white;
    padding: 15px 20px;
    font-size: 1.5em;
    font-weight: bold;
    position: relative;
}
#logoutIconBtn {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: white;
    font-size: 1.4em;
    cursor: pointer;
    transition: transform 0.2s, color 0.2s;
}
#logoutIconBtn:hover {
    color: #ffe082;
    transform: translateY(-50%) scale(1.1);
}
nav {
    display: flex;
    background: #e0f2f1;
    overflow-x: auto;
    border-bottom: 2px solid #ccc;
}
nav button {
    flex: 1;
    padding: 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 1em;
    transition: background 0.3s;
}
nav button.active {
    background: #b2dfdb;
    font-weight: bold;
    border-bottom: 3px solid #0077b6;
}
section { padding: 20px; display: none; }
section.active { display: block; }
.card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}
.search-bar input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
}
.table-container { overflow-x: auto; }
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
th, td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}
th { background: #0077b6; color: white; }
.btn {
    background: #00b894;
    color: white;
    border: none;
    padding: 8px 12px;
    margin: 3px;
    border-radius: 5px;
    cursor: pointer;
}
.btn:hover { background: #019874; }
.alert {
    padding: 10px;
    background: #ffcccc;
    border: 1px solid #ff4d4d;
    color: #b30000;
    border-radius: 5px;
    margin-bottom: 10px;
}
.auth-container {
    max-width: 360px;
    margin: 48px auto;
    background: #fff;
    padding: 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.auth-container h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #0077b6;
}
.auth-container input {
    width: 100%;
    padding: 10px;
    margin-bottom: 12px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 15px;
}
.auth-container button {
    width: 100%;
    padding: 10px;
    background: #00b894;
    color: #fff;
    font-weight: 600;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}
.auth-container button:hover { background: #019874; }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginSection" class="auth-container">
  <h2>Smart PHC Login</h2>
  <input type="email" id="loginEmail" placeholder="Email" />
  <input type="password" id="loginPassword" placeholder="Password" />
  <button onclick="login()">Login</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none;">
<header>
    💊 Smart PHC Medicine Store Dashboard
    <button id="logoutIconBtn" title="Logout" onclick="logout()">🚪</button>
</header>

<nav>
    <button class="tab-btn active" data-tab="stock">Medicine Stock</button>
    <button class="tab-btn" data-tab="expiry">Near Expiry Alerts</button>
    <button class="tab-btn" data-tab="scanner">QR Code Scanner</button>
    <button class="tab-btn" data-tab="reports">Reports</button>
</nav>

<section id="stock" class="active">
    <div class="card">
        <h3>📂 Upload Excel or PDF</h3>
        <input type="file" id="excelFile" accept=".xlsx, .xls" class="btn" />
        <input type="file" id="pdfFile" accept="application/pdf" class="btn" />
        <div class="search-bar" style="margin-top:10px;">
            <input type="text" id="searchBox" placeholder="🔍 Search medicine by name..." />
        </div>
        <select id="rackFilter" class="btn" style="margin-top:10px;">
            <option value="">All Racks</option>
        </select>
    </div>
    <div class="card table-container">
        <table id="medicineTable">
            <thead>
                <tr><th>Medicine Name</th><th>Rack</th><th>Quantity</th><th>Expiry Date</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</section>

<section id="expiry">
    <div class="card">
        <h3>⚠ Near Expiry Medicines</h3>
        <select id="expiryDaysNear" class="btn">
            <option value="30">30 days</option><option value="60">60 days</option>
            <option value="90">90 days</option><option value="180">180 days</option>
        </select>
        <button onclick="renderNearExpiry()" class="btn">Refresh</button>
        <button onclick="exportNearExpiryExcel()" class="btn">Export Excel</button>
        <button onclick="exportNearExpiryPDF()" class="btn">Export PDF</button>
        <div id="expiryAlerts" style="margin-top:10px;"></div>
        <div class="table-container">
            <table id="nearExpiryTable">
                <thead><tr><th>Medicine</th><th>Rack</th><th>Qty</th><th>Expiry</th><th>Status</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</section>

<section id="scanner">
    <div class="card">
        <h3>📷 QR Code Scanner</h3>
        <button id="startScanBtn" class="btn" onclick="startQRScanner()">Start Camera Scan</button>
        <button id="stopScanBtn" class="btn" style="display:none; background:#d9534f;" onclick="stopQRScanner()">Stop Scan</button>
        <div id="qr-reader" style="width:300px; display:none; margin-top:15px;"></div>
        <p id="qrResult"></p>
    </div>
</section>

<section id="reports">
    <div class="card">
        <h3>📊 Export Reports</h3>
        <button onclick="exportExcel()" class="btn">Export Stock Excel</button>
        <button onclick="exportPDF()" class="btn">Export Stock PDF</button>
        <button onclick="exportStockReport()" class="btn">Export Stock Report Excel</button>
    </div>
    <div class="card table-container">
        <table id="stockReportTable">
            <thead><tr><th>Medicine</th><th>Rack</th><th>Qty</th><th>Expiry</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</section>
</div>

<!-- FIREBASE APP LOGIC -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBj_9a5ep2lxKru6yEQqNLHqpSZOm7qi-s",
  authDomain: "smart-phc-dashboard.firebaseapp.com",
  projectId: "smart-phc-dashboard",
  storageBucket: "smart-phc-dashboard.firebasestorage.app",
  messagingSenderId: "519246980359",
  appId: "1:519246980359:web:80d2b1dec39076ad2ad1a2",
  measurementId: "G-QQX4EZK7KP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

window.login = async ()=>{ try{ await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value); }catch(e){ alert(e.message); } };
window.logout = ()=>{ signOut(auth); };

onAuthStateChanged(auth, (user) => {
  if (user) { loginSection.style.display="none"; dashboard.style.display="block"; loadDataFromCloud(); }
  else { dashboard.style.display="none"; loginSection.style.display="block"; }
});

// ===== Smart PHC Logic (import, render, exports, qr, etc) here =====
// (Use same JS from our previous merged working version)
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart PHC Medicine Store - Secure Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>

<style>
/* --- Base styling --- */
body{font-family:Arial,sans-serif;background:#f5fdfc;margin:0;}
.auth-container{max-width:360px;margin:80px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.auth-container input{width:100%;padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:5px;}
.auth-container button{width:100%;padding:10px;background:linear-gradient(90deg,#0077b6,#00b894);color:#fff;font-weight:bold;border:none;border-radius:5px;cursor:pointer;}
.auth-container button:hover{background:#00b894;}
header{background:linear-gradient(90deg,#0077b6,#00b894);color:#fff;padding:15px;font-size:22px;font-weight:bold;display:flex;justify-content:space-between;align-items:center;}
#logoutBtn{background:#fff;color:#0077b6;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;font-weight:bold;}
#logoutBtn:hover{background:#ffeaa7;}
nav{display:flex;background-color:#e3f6f5;border-bottom:1px solid #ccc;}
nav button{flex:1;padding:12px;border:none;background:transparent;font-size:16px;cursor:pointer;}
nav button.active{border-bottom:3px solid #0077b6;font-weight:bold;color:#0077b6;}
.tab-content{display:none;padding:20px;opacity:0;transform:translateY(10px);transition:opacity 0.4s,transform 0.4s;}
.tab-content.active{display:block;opacity:1;transform:translateY(0);}
.alert{background:#ffeaa7;padding:10px;margin-bottom:15px;border-left:5px solid #fdcb6e;}
.controls{display:flex;flex-wrap:wrap;gap:18px;align-items:end;margin-bottom:15px;}
.form-group{display:flex;flex-direction:column;}
.form-group label{color:#0077b6;font-size:14px;margin-bottom:4px;font-weight:600;letter-spacing:0.2px;display:flex;align-items:center;gap:5px;}
input[type="file"],input[type="text"],select{border-radius:8px;border:1px solid #b0e2e0;padding:6px 10px;font-size:15px;background:#e3f6f5;}
input[type="file"]:hover,input[type="text"]:hover,select:hover{border:1.5px solid #00b894;box-shadow:0 1px 3px rgba(0,0,0,0.08);}
.button-group{flex-direction:row;gap:8px;}
button{border-radius:8px;background:linear-gradient(90deg,#0077b6,#00b894);border:none;padding:8px 14px;font-size:14px;font-weight:600;cursor:pointer;color:#fff;}
button:hover{background:#00b894;}
table{width:100%;border-collapse:collapse;background:#fff;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#d0f0ec;}
.fade-in{animation:fadeIn 0.5s forwards;}
.fade-out{animation:fadeOut 0.4s forwards;}
@keyframes fadeIn{from{opacity:0;transform:scale(0.98);} to{opacity:1;transform:scale(1);}}
@keyframes fadeOut{from{opacity:1;transform:scale(1);} to{opacity:0;transform:scale(0.98);}}

/* --- Status highlights --- */
.expired-row {background-color:lightcoral !important;color:white;font-weight:bold;}
.near-expiry-row {background-color:khaki !important;font-weight:bold;}
</style>
</head>
<body>

<!-- Login -->
<div id="loginSection" class="auth-container fade-in">
  <h2>Login</h2>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
<header>
  üíä Smart PHC Medicine Store
  <button id="logoutBtn" onclick="logout()">Logout</button>
</header>

<nav>
  <button class="tab-btn active" data-tab="stock">Medicine Stock</button>
  <button class="tab-btn" data-tab="nearExpiry">Near Expiry</button>
  <button class="tab-btn" data-tab="qr">QR Scanner</button>
  <button class="tab-btn" data-tab="reports">Reports</button>
</nav>

<!-- Stock Tab -->
<div id="stock" class="tab-content active">
  <div class="controls">
    <div class="form-group"><label for="excelFile">üì• Import Excel</label><input type="file" id="excelFile" accept=".xlsx,.xls"></div>
    <div class="form-group"><label for="pdfFile">üìÑ Ack PDF</label><input type="file" id="pdfFile" accept="application/pdf"></div>
    <div class="form-group"><label for="rackFilter">üóÑ Rack</label><select id="rackFilter"><option value="">All Racks</option></select></div>
    <div class="form-group"><label for="searchBox">üîç Search</label><input type="text" id="searchBox" placeholder="Search medicine..."></div>
    <div class="form-group button-group"><button onclick="exportExcel()">üìä Excel</button><button onclick="exportPDF()">üìë PDF</button></div>
  </div>
  <table id="medicineTable"><thead><tr><th>Medicine Name</th><th>Rack</th><th>Quantity</th><th>Expiry Date</th></tr></thead><tbody></tbody></table>
</div>

<!-- Near Expiry Tab -->
<div id="nearExpiry" class="tab-content">
  <div class="alert" id="expiryAlert">No near-expiry medicines.</div>
  <div class="controls">
    <div class="form-group">
      <label for="expiryDaysNear">‚è≥ Show expiring within</label>
      <select id="expiryDaysNear"><option value="30">30 days</option><option value="60">60 days</option><option value="90">90 days</option><option value="100">100 days</option></select>
    </div>
    <div class="form-group button-group"><button onclick="renderNearExpiry()">üîÑ Refresh</button><button onclick="exportNearExpiryExcel()">üìä Excel</button><button onclick="exportNearExpiryPDF()">üìë PDF</button></div>
  </div>
  <table id="nearExpiryTable"><thead><tr><th>Medicine Name</th><th>Rack</th><th>Quantity</th><th>Expiry Date</th><th>Status</th></tr></thead><tbody></tbody></table>
</div>

<!-- Reports Tab -->
<div id="reports" class="tab-content">
  <h3>Stock In Hand Report</h3>
  <div class="controls">
    <div class="form-group button-group"><button onclick="exportStockReport()">üìä Export Stock Report</button></div>
  </div>
  <table id="stockReportTable"><thead><tr><th>Medicine Name</th><th>Rack</th><th>Quantity</th><th>Expiry Date</th></tr></thead><tbody></tbody></table>
</div>

<!-- QR Tab -->
<div id="qr" class="tab-content">
  <button onclick="startQRScanner()">Start Camera Scan</button>
  <div id="qr-reader" style="width:300px; margin-top:15px;"></div>
  <p>Scanned Result: <span id="qrResult"></span></p>
</div>
</div>

<script>
/* === Helpers === */
function toMMYYYY(dateStr){
  if (!dateStr) return "";
  if (Object.prototype.toString.call(dateStr) === "[object Date]" && !isNaN(dateStr)) {
    return ("0" + (dateStr.getMonth() + 1)).slice(-2) + "/" + dateStr.getFullYear();
  }
  dateStr = String(dateStr).trim();
  if (/^\d{2}\/\d{4}$/.test(dateStr)) return dateStr;
  let mdy = dateStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (mdy) return ("0" + mdy[1]).slice(-2) + "/" + mdy[3];
  let ymd = dateStr.match(/^(\d{4})[\/\-](\d{2})[\/\-](\d{2})$/);
  if (ymd) return ymd[2] + "/" + ymd[1];
  let ym = dateStr.match(/^(\d{4})[\/\-](\d{1,2})$/);
  if (ym) return ("0" + ym[2]).slice(-2) + "/" + ym[1];
  let yOnly = dateStr.match(/^(\d{4})$/);
  if (yOnly) return "01/" + yOnly[1];
  if (!isNaN(dateStr) && Number(dateStr) > 30000) {
    let epoch = new Date((Number(dateStr) - 25569) * 86400 * 1000);
    return ("0" + (epoch.getMonth() + 1)).slice(-2) + "/" + epoch.getFullYear();
  }
  let parsed = new Date(dateStr);
  if (!isNaN(parsed)) {
    return ("0" + (parsed.getMonth() + 1)).slice(-2) + "/" + parsed.getFullYear();
  }
  return dateStr;
}
function getLastDateOfExpiryMonth(mmYYYY){
  if(!mmYYYY) return null;
  let [mm,yyyy] = mmYYYY.split("/");
  return new Date(parseInt(yyyy), parseInt(mm), 0);
}
function getExpiryLabel(daysLeft){
  if(daysLeft===null) return "Invalid";
  if(daysLeft<0) return "Expired";
  if(daysLeft===0) return "Expiring Today";
  if(daysLeft<=30) return daysLeft+" days left";
  if(daysLeft<=60) return Math.round(daysLeft/7)+" weeks left";
  if(daysLeft<=365) return "About "+Math.floor(daysLeft/30)+" months left";
  return "More than a year";
}

/* === Firebase Auth === */
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBj_9a5ep2lxKru6yEQqNLHqpSZOm7qi-s",
  authDomain: "smart-phc-dashboard.firebaseapp.com",
  projectId: "smart-phc-dashboard",
  storageBucket: "smart-phc-dashboard.firebasestorage.app",
  messagingSenderId: "519246980359",
  appId: "1:519246980359:web:80d2b1dec39076ad2ad1a2",
  measurementId: "G-QQX4EZK7KP"
};

firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
function login(){auth.signInWithEmailAndPassword(loginEmail.value,loginPassword.value).catch(e=>alert(e.message));}
function logout(){auth.signOut();}
auth.onAuthStateChanged(user=>{
  if(user){
    loginSection.classList.add("fade-out");
    setTimeout(()=>{loginSection.style.display="none";dashboard.style.display="block";dashboard.classList.add("fade-in");},400);
  } else {
    dashboard.classList.add("fade-out");
    setTimeout(()=>{dashboard.style.display="none";loginSection.style.display="block";loginSection.classList.add("fade-in");},400);
  }
});

/* === Data + Near Expiry Rendering with Highlights === */
let medicineData=[]; // rest of your import/export/render logic here

function renderNearExpiry(){
  let threshold = +expiryDaysNear.value, today = new Date();
  let list = medicineData.map(m=>{
    let expDate = getLastDateOfExpiryMonth(toMMYYYY(m["Expiry Date"]));
    let daysLeft = expDate ? Math.ceil((expDate - today) / (1000*60*60*24)) : null;
    return {...m, daysLeft};
  }).filter(m=>m.daysLeft!==null && m.daysLeft <= threshold)
    .sort((a,b)=>a.daysLeft-b.daysLeft);

  let tbody = nearExpiryTable.querySelector("tbody");
  tbody.innerHTML="";
  list.forEach(r=>{
    let rowClass = r.daysLeft<0 ? 'expired-row' : (r.daysLeft >= 0 && r.daysLeft <= threshold ? 'near-expiry-row' : '');
    tbody.innerHTML += `<tr class="${rowClass}">
      <td>${r["Medicine Name"]}</td>
      <td>${r.Rack||""}</td>
      <td>${r.Quantity}</td>
      <td>${toMMYYYY(r["Expiry Date"])</td>
      <td>${getExpiryLabel(r.daysLeft)}</td>
    </tr>`;
  });
}
</script>
</body>
</html>

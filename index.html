<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart PHC Store Dashboard</title>
  <style>
    /* Reset & Base */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: #f0f4f8;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background-color: #2e7d32;
      color: #fff;
      padding: 1rem 1.5rem;
      text-align: center;
      font-size: 1.8rem;
      font-weight: 700;
      box-shadow: 0 2px 5px rgb(0 0 0 / 0.2);
    }
    main {
      flex-grow: 1;
      padding: 1rem 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      justify-content: center;
      align-items: center;
    }
    input[type="text"], select {
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1.5px solid #ccc;
      transition: border-color 0.3s ease;
      min-width: 180px;
    }
    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: #2e7d32;
      box-shadow: 0 0 5px #2e7d32aa;
    }
    button {
      background-color: #2e7d32;
      border: none;
      color: white;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 3px 7px rgb(46 125 50 / 0.6);
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #276227;
    }
    .table-container {
      overflow-x: auto;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      border-radius: 10px;
      background: #fff;
      padding: 0.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      min-width: 700px;
    }
    thead {
      background-color: #2e7d32;
      color: white;
    }
    th, td {
      padding: 0.7rem 1rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    tr.near-expiry {
      background-color: #fff3cd; /* yellow */
      font-weight: 600;
    }
    tr.expired {
      background-color: #f8d7da; /* red */
      text-decoration: line-through;
      color: #721c24;
      font-weight: 700;
    }
    .no-data {
      padding: 1.5rem;
      text-align: center;
      color: #999;
      font-style: italic;
    }
    footer {
      text-align: center;
      padding: 1rem;
      background: #2e7d32;
      color: white;
      font-size: 0.9rem;
    }
    /* Responsive */
    @media(max-width: 720px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      input[type="text"], select {
        min-width: auto;
        width: 100%;
      }
      label[for="fileInput"] {
        width: 100%;
        text-align: center;
      }
    }
    /* QR Scanner overlay */
    #qr-scanner {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.75);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #qr-scanner video {
      width: 320px;
      max-width: 90vw;
      border-radius: 12px;
      box-shadow: 0 0 20px #2e7d32;
    }
    #qr-scanner button {
      margin-top: 1rem;
      background: #c62828;
      box-shadow: 0 3px 7px rgb(198 40 40 / 0.7);
    }
    /* File input style */
    input[type="file"] {
      display: none;
    }
    label[for="fileInput"] {
      cursor: pointer;
      background-color: #1976d2;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      box-shadow: 0 3px 7px rgb(25 118 210 / 0.7);
      transition: background-color 0.3s ease;
      user-select: none;
    }
    label[for="fileInput"]:hover {
      background-color: #115293;
    }
  </style>
</head>
<body>
  <header>
    Smart PHC Store Dashboard
  </header>
  <main>
    <section class="controls" aria-label="Filter and Search Controls">
      <input type="text" id="searchInput" placeholder="Search medicine..." aria-label="Search medicines by name" />
      <select id="rackFilter" aria-label="Filter medicines by rack">
        <option value="">All Racks</option>
      </select>
      <button id="qrScanBtn" title="Scan Rack QR Code">ðŸ“· Scan Rack QR</button>
      <label for="fileInput" title="Import Medicine Data">â¬† Import Data</label>
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" aria-label="Import medicine data file" />
    </section>

    <section class="table-container" aria-label="Medicines List">
      <table id="medicinesTable" role="grid" aria-live="polite">
        <thead>
          <tr>
            <th scope="col">Medicine Name</th>
            <th scope="col">Batch No</th>
            <th scope="col">Expiry Date</th>
            <th scope="col">Quantity</th>
            <th scope="col">Rack Code</th>
            <th scope="col">Color Code</th>
            <th scope="col">Reorder Level</th>
          </tr>
        </thead>
        <tbody>
          <!-- Dynamically filled -->
        </tbody>
      </table>
      <div id="noDataMsg" class="no-data" style="display:none;">No medicines found.</div>
    </section>
  </main>

  <!-- QR Scanner Overlay -->
  <section id="qr-scanner" role="dialog" aria-modal="true" aria-label="QR Code Scanner">
    <video id="qr-video" muted playsinline></video>
    <button id="closeScannerBtn" aria-label="Close QR Scanner">âœ– Close</button>
  </section>

  <footer>
    &copy; 2025 PHC Smart Store | Developed for Primary Health Center
  </footer>

  <!-- SheetJS Library for Excel parsing -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/shim.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    // Sample medicine data â€” initial demo
    let medicines = [
      {
        name: "Paracetamol",
        batch: "B1234",
        expiry: "2025-09-15",
        quantity: 150,
        rack: "R1",
        color: "Green",
        reorder: 50
      },
      {
        name: "Amlodipine 5mg",
        batch: "A4567",
        expiry: "2025-08-20",
        quantity: 30,
        rack: "R2",
        color: "Yellow",
        reorder: 40
      },
      {
        name: "Amoxicillin",
        batch: "AM890",
        expiry: "2025-07-30",
        quantity: 20,
        rack: "R1",
        color: "Red",
        reorder: 30
      },
      {
        name: "Ibuprofen",
        batch: "I1357",
        expiry: "2026-01-10",
        quantity: 120,
        rack: "R3",
        color: "Blue",
        reorder: 40
      },
      {
        name: "Metformin",
        batch: "M2468",
        expiry: "2025-08-01",
        quantity: 10,
        rack: "R2",
        color: "Orange",
        reorder: 20
      }
    ];

    const searchInput = document.getElementById('searchInput');
    const rackFilter = document.getElementById('rackFilter');
    const medicinesTableBody = document.querySelector('#medicinesTable tbody');
    const noDataMsg = document.getElementById('noDataMsg');
    const qrScanBtn = document.getElementById('qrScanBtn');
    const fileInput = document.getElementById('fileInput');

    // QR Scanner elements
    const qrScanner = document.getElementById('qr-scanner');
    const qrVideo = document.getElementById('qr-video');
    const closeScannerBtn = document.getElementById('closeScannerBtn');

    // Populate rack filter options dynamically
    function populateRackFilter() {
      // Clear existing options except first
      rackFilter.options.length = 1;
      const racks = [...new Set(medicines.map(med => med.rack))].sort();
      racks.forEach(rack => {
        const option = document.createElement('option');
        option.value = rack;
        option.textContent = rack;
        rackFilter.appendChild(option);
      });
    }

    // Check expiry status: return 'expired', 'near-expiry', or ''
    function checkExpiry(expiryDateStr) {
      const today = new Date();
      const expiryDate = new Date(expiryDateStr);
      const diffTime = expiryDate - today;
      const diffDays = diffTime / (1000 * 3600 * 24);

      if (diffDays < 0) return 'expired';
      if (diffDays <= 30) return 'near-expiry';
      return '';
    }

    // Render medicines table based on filters
    function renderTable() {
      const searchTerm = searchInput.value.trim().toLowerCase();
      const rackSelected = rackFilter.value;

      let filtered = medicines.filter(med => {
        const matchesName = med.name.toLowerCase().includes(searchTerm);
        const matchesRack = rackSelected ? (med.rack === rackSelected) : true;
        return matchesName && matchesRack;
      });

      medicinesTableBody.innerHTML = '';

      if (filtered.length === 0) {
        noDataMsg.style.display = 'block';
        return;
      } else {
        noDataMsg.style.display = 'none';
      }

      filtered.forEach(med => {
        const tr = document.createElement('tr');
        const expiryStatus = checkExpiry(med.expiry);
        if (expiryStatus === 'expired') {
          tr.classList.add('expired');
        } else if (expiryStatus === 'near-expiry') {
          tr.classList.add('near-expiry');
        }

        tr.innerHTML = `
          <td>${med.name}</td>
          <td>${med.batch}</td>
          <td>${med.expiry}</td>
          <td>${med.quantity}</td>
          <td>${med.rack}</td>
          <td>${med.color}</td>
          <td>${med.reorder}</td>
        `;
        medicinesTableBody.appendChild(tr);
      });
    }

    // Event listeners for search and rack filter
    searchInput.addEventListener('input', renderTable);
    rackFilter.addEventListener('change', renderTable);

    // Initialize rack filter options and render table on load
    populateRackFilter();
    renderTable();

    // ----------- QR Code Scanner Setup -----------

    let html5QrcodeScanner = null;

    qrScanBtn.addEventListener('click', () => {
      qrScanner.style.display = 'flex';

      if (!html5QrcodeScanner) {
        loadHtml5QrcodeLib().then(() => {
          startQrScanner();
        });
      } else {
        startQrScanner();
      }
    });

    closeScannerBtn.addEventListener('click', () => {
      stopQrScanner();
      qrScanner.style.display = 'none';
    });

    function loadHtml5QrcodeLib() {
      return new Promise((resolve, reject) => {
        if (window.Html5Qrcode) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = "https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js";
        script.onload = () => resolve();
        script.onerror = () => reject('Failed to load QR code library');
        document.head.appendChild(script);
      });
    }

    function startQrScanner() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: 250
          },
          qrCodeSuccessCallback
        ).catch(err => {
          alert("Unable to start QR scanner: " + err);
          qrScanner.style.display = 'none';
        });
        return;
      }
      html5QrcodeScanner = new Html5Qrcode("qr-video");
      html5QrcodeScanner.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: 250
        },
        qrCodeSuccessCallback
      ).catch(err => {
        alert("Unable to start QR scanner: " + err);
        qrScanner.style.display = 'none';
      });
    }

    function stopQrScanner() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
          html5QrcodeScanner.clear();
        }).catch(err => {
          console.warn("Failed to stop QR scanner", err);
        });
      }
    }

    function qrCodeSuccessCallback(decodedText, decodedResult) {
      stopQrScanner();
      qrScanner.style.display = 'none';

      if ([...rackFilter.options].some(opt => opt.value === decodedText)) {
        rackFilter.value = decodedText;
        renderTable();
        alert(`Filtered medicines by Rack Code: ${decodedText}`);
      } else {
        alert(`Rack Code "${decodedText}" not found in current data.`);
      }
    }

    // ----------- Import Data Handler -----------

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      const filename = file.name.toLowerCase();

      reader.onload = (evt) => {
        let data = evt.target.result;

        try {
          let workbook;

          if (filename.endsWith('.csv')) {
            // CSV parsing
            const text = evt.target.result;
            processCSV(text);
          } else {
            // Excel parsing
            const uint8Array = new Uint8Array(data);
            workbook = XLSX.read(uint8Array, { type: "array" });
            processWorkbook(workbook);
          }
        } catch (error) {
          alert("Error processing file: " + error.message);
        }
      };

      if (filename.endsWith('.csv')) {
        reader.readAsText(file);
      } else {
        reader.readAsArrayBuffer(file);
      }
    });

    function processWorkbook(workbook) {
      // Use first sheet
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

      parseImportedData(jsonData);
    }

    function processCSV(csvText) {
      // Convert CSV text to JSON array using SheetJS
      const worksheet = XLSX.utils.csv_to_sheet(csvText);
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

      parseImportedData(jsonData);
    }

    // Parse JSON array and map to medicine structure
    function parseImportedData(dataArray) {
      // Expected columns (case insensitive, trimmed): 
      // Medicine Name, Batch No, Expiry Date, Quantity, Rack Code, Color Code, Reorder Level

      const mappedMedicines = [];

      for (const row of dataArray) {
        // Normalize keys to lowercase without spaces for easier matching
        const keys = {};
        for (const k in row) {
          keys[k.trim().toLowerCase().replace(/\s+/g, '')] = row[k];
        }

        // Required fields - skip rows without medicine name or expiry
        if (!keys.medicinename) continue;

        // Parse date in ISO format yyyy-mm-dd or dd/mm/yyyy or mm/dd/yyyy heuristics
        let expiryStr = keys.expirydate || keys.expiry || "";
        let expiryDateISO = parseDateToISO(expiryStr);
        if (!expiryDateISO) {
          // Skip if expiry date not parseable
          continue;
        }

        // Parse quantity and reorder as numbers (default 0)
        const quantity = parseInt(keys.quantity) || 0;
        const reorder = parseInt(keys.reorderlevel) || 0;

        mappedMedicines.push({

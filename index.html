<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart PHC Medicine Store Dashboard</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: linear-gradient(135deg, #d0f0f0, #b0e5d8);
        color: #333;
        background-image:
          repeating-linear-gradient(
            45deg,
            rgba(255,255,255,0.15),
            rgba(255,255,255,0.15) 10px,
            transparent 10px,
            transparent 20px
          ),
          linear-gradient(135deg, #d0f0f0, #b0e5d8);
    }
    header {
        background: linear-gradient(90deg, #0077b6, #00b894);
        color: white;
        padding: 15px 20px;
        text-align: center;
        font-size: 1.5em;
        font-weight: bold;
    }
    nav {
        display: flex;
        background: #e0f2f1;
        overflow-x: auto;
        border-bottom: 2px solid #ccc;
    }
    nav button {
        flex: 1;
        padding: 12px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 1em;
        transition: background 0.3s;
    }
    nav button.active {
        background: #b2dfdb;
        font-weight: bold;
        border-bottom: 3px solid #0077b6;
    }
    section {
        padding: 20px;
        display: none;
    }
    section.active {
        display: block;
    }
    .card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .search-bar input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    .table-container {
        overflow-x: auto;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    th {
        background: #0077b6;
        color: white;
    }
    .btn {
        background: #00b894;
        color: white;
        border: none;
        padding: 8px 12px;
        margin: 3px;
        border-radius: 5px;
        cursor: pointer;
    }
    .btn:hover {
        background: #019874;
    }
    .alert {
        padding: 10px;
        background: #ffcccc;
        border: 1px solid #ff4d4d;
        color: #b30000;
        border-radius: 5px;
        margin-bottom: 10px;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

</head>
<body>

<header>💊 Smart PHC Medicine Store Dashboard</header>

<nav>
    <button class="tab-btn active" data-tab="stock">Medicine Stock</button>
    <button class="tab-btn" data-tab="expiry">Near Expiry Alerts</button>
    <button class="tab-btn" data-tab="scanner">QR Code Scanner</button>
    <button class="tab-btn" data-tab="reports">Reports</button>
</nav>

<section id="stock" class="active">
    <div class="card">
        <h3>📂 Upload Excel or Use Google Sheets</h3>
        <input type="file" id="excelFile" accept=".xlsx, .xls" class="btn" />
        <div style="margin-top:10px; font-size:0.9em; color:#555;">
            OR<br />
            Google Sheet Live Data (Update below sheetID and refresh page)
        </div>
        <div class="search-bar" style="margin-top:10px;">
            <input type="text" id="searchInput" placeholder="🔍 Search medicine by name..." />
        </div>
        <select id="rackFilter" class="btn" style="margin-top:10px;">
            <option value="">All Racks</option>
        </select>
    </div>
    <div class="card table-container">
        <table id="medicineTable">
            <thead>
                <tr>
                    <th>Medicine Name</th>
                    <th>Rack</th>
                    <th>Quantity</th>
                    <th>Expiry Date</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data loads here -->
            </tbody>
        </table>
    </div>
</section>

<section id="expiry">
    <div class="card">
        <h3>⚠ Near Expiry Medicines (Within 30 Days)</h3>
        <div id="expiryAlerts">
            <!-- Alerts appear here -->
        </div>
    </div>
</section>

<section id="scanner">
    <div class="card">
        <h3>📷 QR Code Scanner</h3>
        <button id="startScanner" class="btn">Start Camera Scan</button>
        <video id="qrVideo" width="300" height="200" style="display:none; border:1px solid #ccc;"></video>
        <p id="qrResult"></p>
    </div>
</section>

<section id="reports">
    <div class="card">
        <h3>📊 Export Reports</h3>
        <button id="exportExcel" class="btn">Export to Excel</button>
        <button id="exportPDF" class="btn">Export to PDF</button>
    </div>
</section>

<script>
    const sheetID = 'PUT_YOUR_GOOGLE_SHEET_ID_HERE';

    // Tab switching
    document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
            document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
            btn.classList.add("active");
            const activeTab = document.getElementById(btn.dataset.tab);
            activeTab.classList.add("active");
            if(btn.dataset.tab === 'expiry'){
                updateExpiryAlerts();
            }
        });
    });

    let medicinesData = [];

    const rackFilter = document.getElementById('rackFilter');

    // Excel serial number to JS Date converter
    function excelDateToJSDate(serial) {
      const utc_days = serial - 25569;
      const utc_value = utc_days * 86400; 
      const date_info = new Date(utc_value * 1000);
      return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate());
    }

    // Parse date from Excel serial or string
    function parseDate(value) {
      if(!value) return null;

      if(typeof value === 'number') {
        return excelDateToJSDate(value);
      }

      if(typeof value === 'string') {
        value = value.trim();
        const dmyMatch = value.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if(dmyMatch) {
          const d = parseInt(dmyMatch[1], 10);
          const m = parseInt(dmyMatch[2], 10) - 1;
          const y = parseInt(dmyMatch[3], 10);
          return new Date(y, m, d);
        }
        const isoMatch = value.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
        if(isoMatch) {
          const y = parseInt(isoMatch[1], 10);
          const m = parseInt(isoMatch[2], 10) - 1;
          const d = parseInt(isoMatch[3], 10);
          return new Date(y, m, d);
        }
        let dt = new Date(value);
        if(!isNaN(dt)) return dt;
      }

      return null;
    }

    // Populate Rack Filter options dynamically
    function populateRackFilterOptions(){
        const racks = [...new Set(medicinesData.map(row => row['Rack']).filter(r => r))];
        racks.sort();
        rackFilter.innerHTML = '<option value="">All Racks</option>';
        racks.forEach(rack => {
            const opt = document.createElement('option');
            opt.value = rack;
            opt.textContent = rack;
            rackFilter.appendChild(opt);
        });
    }

    // Render medicine table
    function renderMedicineTable(data){
        const tbody = document.querySelector("#medicineTable tbody");
        tbody.innerHTML = '';
        data.forEach(row => {
            const tr = document.createElement('tr');

            const tdName = document.createElement('td');
            tdName.textContent = row['Medicine Name'] || '';

            const tdRack = document.createElement('td');
            tdRack.textContent = row['Rack'] || '';

            const tdQty = document.createElement('td');
            tdQty.textContent = row['Quantity'] || '';

            const tdExpiry = document.createElement('td');
            tdExpiry.textContent = row['Expiry Date'] || '';

            tr.appendChild(tdName);
            tr.appendChild(tdRack);
            tr.appendChild(tdQty);
            tr.appendChild(tdExpiry);

            tbody.appendChild(tr);
        });
    }

    // Refresh UI based on search & rack filter
    function refreshUI(){
        let filteredData = medicinesData;

        const searchVal = document.getElementById('searchInput').value.toLowerCase();
        if(searchVal) {
            filteredData = filteredData.filter(row => (row['Medicine Name'] || '').toLowerCase().includes(searchVal));
        }
        const rackVal = rackFilter.value;
        if(rackVal) {
            filteredData = filteredData.filter(row => row['Rack'] === rackVal);
        }

        renderMedicineTable(filteredData);

        if(document.getElementById('expiry').classList.contains('active')){
            updateExpiryAlerts();
        }
    }

    document.getElementById('searchInput').addEventListener('keyup', refreshUI);
    rackFilter.addEventListener('change', refreshUI);

    // Update Near Expiry Alerts
    function updateExpiryAlerts(){
        const alertBox = document.getElementById('expiryAlerts');
        alertBox.innerHTML = '';
        const now = new Date();

        let filteredData = medicinesData;

        const searchVal = document.getElementById('searchInput').value.toLowerCase();
        const rackVal = rackFilter.value;
        if(searchVal) {
            filteredData = filteredData.filter(row => (row['Medicine Name'] || '').toLowerCase().includes(searchVal));
        }
        if(rackVal) {
            filteredData = filteredData.filter(row => row['Rack'] === rackVal);
        }

        const nearExpiryMeds = filteredData.filter(row => {
            const expiryDate = parseDate(row['Expiry Date']);
            if(expiryDate){
                const diffDays = Math.ceil((expiryDate - now) / (1000*60*60*24));
                return diffDays <= 30 && diffDays >= 0;
            }
            return false;
        });

        if(nearExpiryMeds.length === 0){
            alertBox.innerHTML = '<div>No medicines nearing expiry in 30 days.</div>';
        } else {
            nearExpiryMeds.forEach(row => {
                alertBox.innerHTML += `<div class="alert">${row['Medicine Name']} - Expires on ${row['Expiry Date']}</div>`;
            });
        }
    }

    // Excel file upload handler
    document.getElementById('excelFile').addEventListener('change', function(e){
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(event){
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            medicinesData = XLSX.utils.sheet_to_json(worksheet, {defval: ''});

            // Save Excel data to localStorage
            localStorage.setItem('medicinesData', JSON.stringify(medicinesData));

            populateRackFilterOptions();
            refreshUI();
        }
        reader.readAsArrayBuffer(file);
    });

    // On page load, first try loading localStorage data (Excel upload)
    // If not found, fetch Google Sheets data live
    window.addEventListener('load', () => {
        const savedData = localStorage.getItem('medicinesData');
        if(savedData){
            medicinesData = JSON.parse(savedData);
            populateRackFilterOptions();
            refreshUI();
        } else {
            // Fetch Google Sheets data live
            fetchGoogleSheetData();
        }
    });

    // Fetch Google Sheet data published as JSON
    function fetchGoogleSheetData(){
        if(!sheetID || sheetID === 'PUT_YOUR_GOOGLE_SHEET_ID_HERE') return;

        const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

        fetch(url)
        .then(res => res.text())
        .then(rep => {
            const jsonData = JSON.parse(rep.substr(47).slice(0, -2));
            const rows = jsonData.table.rows;

            medicinesData = rows.map(row => {
                return {
                    'Medicine Name': row.c[0]?.v || '',
                    'Rack': row.c[1]?.v || '',
                    'Quantity': row.c[2]?.v || '',
                    'Expiry Date': row.c[3]?.v || '',
                };
            });

            populateRackFilterOptions();
            refreshUI();
        })
        .catch(e => {
            console.error('Google Sheet fetch error:', e);
        });
    }

    // Placeholder QR Scanner and Export buttons
    document.getElementById("startScanner").addEventListener("click", () => {
        alert("QR Scanning feature placeholder – integrate with jsQR or other libraries.");
    });

    document.getElementById("exportExcel").addEventListener("click", () => {
        alert("Export to Excel functionality will be added here.");
    });
    document.getElementById("exportPDF").addEventListener("click", () => {
        alert("Export to PDF functionality will be added here.");
    });
</script>

</body>
</html>

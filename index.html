<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart PHC Medicine Store Dashboard (FEFO/Expiry Tracks)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- CDN Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; background: #f5fdfc; margin: 0; color: #333; }
    header { background: linear-gradient(90deg, #0077b6, #00b894); color: #fff; padding: 15px; text-align: center; font-size: 22px; font-weight: bold;}
    nav { display: flex; background-color: #e3f6f5; border-bottom: 1px solid #ccc; }
    nav button { flex: 1; padding: 12px; background: transparent; border: none; font-size: 16px; cursor: pointer;}
    nav button.active { border-bottom: 3px solid #0077b6; font-weight: bold; color: #0077b6;}
    .tab-content { display: none; padding: 20px;}
    .tab-content.active { display: block;}
    .controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
    select, input[type="file"], input[type="text"], button, label { padding: 8px; border: 1px solid #ccc; border-radius: 5px;}
    label { border: none; font-weight: bold; padding-left: 0;}
    button { background-color: #0077b6; color: #fff; cursor: pointer;}
    button:hover { background-color: #00b894;}
    table { width: 100%; border-collapse: collapse; background: #fff; }
    table th, table td { border: 1px solid #ccc; padding: 8px; text-align: center;}
    table th { background: #d0f0ec; }
    .alert { background: #ffeaa7; padding: 10px; margin-bottom: 15px; border-left: 5px solid #fdcb6e; }
</style>
</head>
<body>

<header>ðŸ’Š Smart PHC Medicine Store Dashboard</header>

<nav>
    <button class="tab-btn active" data-tab="stock">Medicine Stock</button>
    <button class="tab-btn" data-tab="nearExpiry">Near Expiry</button>
    <button class="tab-btn" data-tab="qr">QR Scanner</button>
    <button class="tab-btn" data-tab="reports">Reports</button>
</nav>

<!-- STOCK TAB -->
<div id="stock" class="tab-content active">
    <div class="alert" id="expiryAlert">No near-expiry medicines.</div>
    <div class="controls">
        <input type="file" id="excelFile" accept=".xlsx,.xls">
        <input type="file" id="pdfFile" accept="application/pdf">
        <button onclick="processPDF()">Upload PDF</button>
        <select id="rackFilter"><option value="">All Racks</option></select>
        <input type="text" id="searchBox" placeholder="Search medicine...">
        <label for="expiryDaysStock">Near Expiry (days):</label>
        <select id="expiryDaysStock">
            <option value="30">30</option>
            <option value="60">60</option>
            <option value="90">90</option>
            <option value="100">100</option>
        </select>
        <button onclick="exportExcel()">Export Excel</button>
        <button onclick="exportPDF()">Export PDF</button>
    </div>
    <table id="medicineTable">
        <thead>
            <tr>
                <th>Medicine Name</th>
                <th>Rack</th>
                <th>Quantity</th>
                <th>Expiry Date</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- NEAR EXPIRY TAB -->
<div id="nearExpiry" class="tab-content">
    <h3>Near Expiry Medicines</h3>
    <div class="controls" style="margin-bottom:5px;">
        <label for="expiryDaysNear">Show medicines expiring within:</label>
        <select id="expiryDaysNear">
            <option value="30">30 Days</option>
            <option value="60">60 Days</option>
            <option value="90">90 Days</option>
            <option value="100">100 Days</option>
        </select>
        <button onclick="renderNearExpiry()">Refresh</button>
        <button onclick="exportNearExpiryExcel()">Export Excel</button>
        <button onclick="exportNearExpiryPDF()">Export PDF</button>
    </div>
    <table id="nearExpiryTable">
        <thead>
            <tr>
                <th>Medicine Name</th>
                <th>Rack</th>
                <th>Quantity</th>
                <th>Expiry Date</th>
                <th>Days Left</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- QR SCANNER TAB -->
<div id="qr" class="tab-content">
    <button onclick="startQRScanner()">Start Camera Scan</button>
    <div id="qr-reader" style="width:300px; margin-top:15px;"></div>
    <p>Scanned Result: <span id="qrResult"></span></p>
</div>

<!-- REPORTS TAB -->
<div id="reports" class="tab-content">
    <h3>Reports</h3>
    <p>View and download stock & expiry reports.</p>
</div>

<script>
let medicineData = [];

function unique(arr) {
    return Array.from(new Set(arr));
}

// Tab switching
document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
        if(btn.dataset.tab === "nearExpiry") renderNearExpiry();
    });
});

// Excel upload
document.getElementById("excelFile").addEventListener("change", function(){
    const file = this.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            let newData = XLSX.utils.sheet_to_json(sheet);
            medicineData = mergeWithExistingStock(medicineData, newData);
            renderTable();
            checkExpiry();
        };
        reader.readAsArrayBuffer(file);
    }
});

// PDF Acknowledgement processing
async function processPDF() {
    const input = document.getElementById('pdfFile');
    if (!input.files.length) { alert('Select a PDF first'); return; }
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = async function () {
        const typedarray = new Uint8Array(this.result);
        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
        let allText = '';
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const txt = await page.getTextContent();
            allText += txt.items.map(item => item.str).join(' ') + '\n';
        }
        parseMedicineTable(allText);
    };
    reader.readAsArrayBuffer(file);
}

function parseMedicineTable(text) {
    let lines = text.split('\n');
    let newData = [];
    for (let line of lines) {
        // Adjust regex for your typical PDF row format ("Name  MM/YYYY  Qty")
        let match = line.match(/([A-Za-z0-9\s]+)\s+(\d{2}\/\d{4})\s+(\d+)/);
        if (match) {
            newData.push({
                "Medicine Name": match[1].trim(),
                "Expiry Date": match[2].trim(),
                "Quantity": parseInt(match[3].trim(), 10),
                "Rack": ""
            });
        }
    }
    if (newData.length) {
        medicineData = mergeWithExistingStock(medicineData, newData);
        renderTable();
        checkExpiry();
        alert("PDF imported successfully!");
    } else {
        alert("No medicines found in PDF. Adjust parsing if needed.");
    }
}

// Merge with FEFO: batches are separate per medicine+expiry
function mergeWithExistingStock(existing, incoming) {
    for (let newMed of incoming) {
        let found = existing.find(old =>
            old["Medicine Name"].toLowerCase() === newMed["Medicine Name"].toLowerCase() &&
            old["Expiry Date"] === newMed["Expiry Date"]
        );
        if (found) {
            found.Quantity += newMed.Quantity;
        } else {
            existing.push(newMed);
        }
    }
    return existing;
}

// Render table sorted FEFO + rack/search filter
function renderTable(){
    const tbody = document.querySelector("#medicineTable tbody");
    tbody.innerHTML = "";
    let rack = document.getElementById("rackFilter").value.toLowerCase();
    let search = document.getElementById("searchBox").value.toLowerCase();
    // Fill rack dropdown
    let racks = unique(medicineData.map(m => m.Rack).filter(r => r));
    let rackSelect = document.getElementById("rackFilter");
    rackSelect.innerHTML = "<option value=''>All Racks</option>";
    racks.forEach(r => rackSelect.innerHTML += `<option value="${r}">${r}</option>`);
    // FEFO sort
    let sortedData = [...medicineData].sort((a,b) =>
        new Date(a["Expiry Date"]) - new Date(b["Expiry Date"])
    );
    sortedData.forEach(row => {
        if ((rack && row.Rack?.toLowerCase() !== rack) ||
            (search && !row["Medicine Name"].toLowerCase().includes(search))) return;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row["Medicine Name"]}</td>
                        <td>${row.Rack || ""}</td>
                        <td>${row.Quantity}</td>
                        <td>${row["Expiry Date"]}</td>`;
        tbody.appendChild(tr);
    });
}

document.getElementById("rackFilter").addEventListener("change", renderTable);
document.getElementById("searchBox").addEventListener("input", renderTable);

// Expiry check (threshold from dropdown)
function checkExpiry() {
    let alertBox = document.getElementById("expiryAlert");
    let today = new Date();
    let threshold = parseInt(document.getElementById("expiryDaysStock").value, 10);
    let nearExpiry = medicineData.filter(med => {
        let expDate = new Date(med["Expiry Date"]);
        let diff = (expDate - today) / (1000*60*60*24);
        return diff <= threshold && diff >= 0;
    });
    alertBox.innerHTML = nearExpiry.length > 0 ?
        `âš  ${nearExpiry.length} batches expiring within ${threshold} days!` :
        `No medicines expiring within ${threshold} days.`;
}

// React to near expiry threshold change in stock tab
document.getElementById("expiryDaysStock").addEventListener("change", checkExpiry);

function exportExcel(){
    const ws = XLSX.utils.json_to_sheet(medicineData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Stock");
    XLSX.writeFile(wb, "medicine_stock.xlsx");
}
function exportPDF(){
    const element = document.getElementById("medicineTable");
    html2pdf().from(element).save("medicine_stock.pdf");
}

// -------- NEAR EXPIRY TAB --------
function renderNearExpiry() {
    let days = parseInt(document.getElementById("expiryDaysNear").value, 10);
    let today = new Date();
    let nearExpiryList = medicineData
        .map(med => {
            let expDate = new Date(med["Expiry Date"]);
            let daysLeft = Math.ceil((expDate - today) / (1000*60*60*24));
            return { ...med, daysLeft };
        })
        .filter(med => med.daysLeft <= days && med.daysLeft >= 0)
        .sort((a,b) => a.daysLeft - b.daysLeft);
    let tbody = document.getElementById("nearExpiryTable").querySelector("tbody");
    tbody.innerHTML = "";
    nearExpiryList.forEach(row => {
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${row["Medicine Name"]}</td>
                        <td>${row.Rack || ""}</td>
                        <td>${row.Quantity}</td>
                        <td>${row["Expiry Date"]}</td>
                        <td>${row.daysLeft}</td>`;
        tbody.appendChild(tr);
    });
}

// Near expiry export
function exportNearExpiryExcel(){
    let days = parseInt(document.getElementById("expiryDaysNear").value, 10);
    let today = new Date();
    let nearExpiryList = medicineData
        .map(med => {
            let expDate = new Date(med["Expiry Date"]);
            let daysLeft = Math.ceil((expDate - today) / (1000*60*60*24));
            return { ...med, daysLeft };
        })
        .filter(med => med.daysLeft <= days && med.daysLeft >= 0)
        .sort((a,b) => a.daysLeft - b.daysLeft);
    const ws = XLSX.utils.json_to_sheet(nearExpiryList);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Near Expiry");
    XLSX.writeFile(wb, "near_expiry.xlsx");
}
function exportNearExpiryPDF(){
    const element = document.getElementById("nearExpiryTable");
    html2pdf().from(element).save("near_expiry.pdf");
}

// If Near Expiry days dropdown changes, refresh table
document.getElementById("expiryDaysNear").addEventListener("change", renderNearExpiry);

// -------- QR SCAN --------
function startQRScanner(){
    const qrReader = new Html5Qrcode("qr-reader");
    qrReader.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        msg => {
            document.getElementById("qrResult").textContent = msg;
            qrReader.stop();
        }
    );
}
</script>
</body>
</html>

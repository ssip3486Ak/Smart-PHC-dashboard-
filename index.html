<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart PHC Medicine Store Dashboard</title>

<!-- External libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background-image:
    repeating-linear-gradient(45deg, rgba(255,255,255,0.15), rgba(255,255,255,0.15) 10px, transparent 10px, transparent 20px),
    linear-gradient(135deg, #d0f0f0, #b0e5d8);
  color: #333;
}
header {
  background: linear-gradient(90deg, #0077b6, #00b894);
  color: white;
  padding: 15px 20px;
  font-size: 1.5em;
  font-weight: bold;
  text-align: center;
}
nav {
  display: flex;
  background: #e0f2f1;
  overflow-x: auto;
  border-bottom: 2px solid #ccc;
}
nav button {
  flex: 1;
  padding: 12px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 1em;
}
nav button.active {
  background: #b2dfdb;
  font-weight: bold;
  border-bottom: 3px solid #0077b6;
}
section { padding: 20px; display: none; }
section.active { display: block; }
.card {
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}
.search-bar input {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 5px;
}
.table-container { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
th { background: #0077b6; color: white; }
.btn {
  background: #00b894;
  color: white;
  border: none;
  padding: 8px 12px;
  margin: 3px;
  border-radius: 5px;
  cursor: pointer;
}
.btn:hover { background: #019874; }
.alert {
  padding: 10px;
  background: #ffcccc;
  border: 1px solid #ff4d4d;
  color: #b30000;
  border-radius: 5px;
  margin-bottom: 10px;
}
.auth-container {
  max-width: 360px;
  margin: 48px auto;
  background: #fff;
  padding: 24px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.auth-container h2 {
  text-align: center;
  margin-bottom: 20px;
  color: #0077b6;
}
.auth-container input {
  width: 100%;
  padding: 10px;
  margin-bottom: 12px;
  border: 1px solid #ccc;
  border-radius: 5px;
  font-size: 15px;
}
.auth-container button {
  width: 100%;
  padding: 10px;
  background: #00b894;
  color: #fff;
  font-weight: 600;
  border: none;
  border-radius: 5px;
  font-size: 16px;
  cursor: pointer;
}
.auth-container button:hover { background: #019874; }
#deductionConfirmationModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: none; 
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
#deductionConfirmationModal .modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
#deductionConfirmationModal .modal-content h3 {
  margin-top: 0;
}
#deductionConfirmationModal .modal-content button {
  margin-right: 10px;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginSection" class="auth-container">
  <h2>Smart PHC Login</h2>
  <input type="email" id="loginEmail" placeholder="Email" />
  <input type="password" id="loginPassword" placeholder="Password" />
  <button onclick="login()">Login</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none;">
<header>
  ðŸ’Š Smart PHC Medicine Store Dashboard
</header>

<nav>
  <button class="tab-btn active" data-tab="stock">Medicine Stock</button>
  <button class="tab-btn" data-tab="expiry">Near Expiry Alerts</button>
  <button class="tab-btn" data-tab="scanner">QR Code Scanner</button>
  <button class="tab-btn" data-tab="reports">Reports</button>
</nav>

<section id="stock" class="active">
  <div class="card">
    <h3>ðŸ“‚ Upload Medicine Stock File</h3>
    <input type="file" id="excelFile" accept=".xlsx,.xls" class="btn" />
    <input type="file" id="pdfFile" accept="application/pdf" class="btn" />
    <div style="margin-top:10px;">
      <button id="deductionBtn" class="btn">Deduct Medicines (Photo/PDF)</button>
      <input type="file" id="deductionFile" accept="application/pdf,image/*" style="display:none" />
    </div>
    <div class="search-bar" style="margin-top:10px;">
      <input type="text" id="searchBox" placeholder="ðŸ” Search medicine..." />
    </div>
    <select id="rackFilter" class="btn" style="margin-top:10px;"><option value="">All Racks</option></select>
  </div>
  <div class="card table-container" style="height:400px; overflow-y:auto;" id="virtualScrollContainer">
    <table id="medicineTable">
      <thead><tr><th>Medicine</th><th>Rack</th><th>Qty</th><th>Expiry</th></tr></thead>
      <tbody id="medicineTableBody"></tbody>
    </table>
  </div>
</section>

<section id="expiry">
  <div class="card">
    <h3>âš  Near Expiry Medicines</h3>
    <select id="expiryDaysNear" class="btn">
      <option value="30">30 days</option><option value="60">60 days</option><option value="90">90 days</option><option value="180">180 days</option>
    </select>
    <button onclick="renderNearExpiry()" class="btn">Refresh</button>
    <button onclick="exportNearExpiryExcel()" class="btn">Export Excel</button>
    <button onclick="exportNearExpiryPDF()" class="btn">Export PDF</button>
    <div id="expiryAlerts" style="margin-top:10px;"></div>
    <div class="table-container"><table id="nearExpiryTable"><thead><tr><th>Medicine</th><th>Rack</th><th>Qty</th><th>Expiry</th><th>Status</th></tr></thead><tbody></tbody></table></div>
  </div>
</section>

<section id="scanner">
  <div class="card">
    <h3>ðŸ“· QR Code Scanner</h3>
    <button id="startScanBtn" class="btn" onclick="startQRScanner()">Start Camera</button>
    <button id="stopScanBtn" class="btn" style="display:none;background:#d9534f;" onclick="stopQRScanner()">Stop</button>
    <div id="qr-reader" style="width:300px;display:none;margin-top:15px;"></div>
    <p id="qrResult"></p>
  </div>
</section>

<section id="reports">
  <div class="card">
    <h3>ðŸ“Š Export Reports</h3>
    <button onclick="exportExcel()" class="btn">Export Stock Excel</button>
    <button onclick="exportPDF()" class="btn">Export Stock PDF</button>
    <button onclick="exportStockReport()" class="btn">Export Stock Report Excel</button>
  </div>
  <div class="card table-container"><table id="stockReportTable"><thead><tr><th>Medicine</th><th>Rack</th><th>Qty</th><th>Expiry</th></tr></thead><tbody></tbody></table></div>
</section>

<!-- Deduction Confirmation Modal -->
<div id="deductionConfirmationModal">
  <div class="modal-content">
    <h3>Confirm Deduction</h3>
    <p id="deductionSummary"></p>
    <button id="confirmDeductionBtn" class="btn">Confirm</button>
    <button id="cancelDeductionBtn" class="btn" style="background:#d9534f;">Cancel</button>
  </div>
</div>

<!-- LOGOUT AT BOTTOM -->
<div style="text-align:center; padding:20px;">
  <button onclick="logout()" class="btn" style="background:#d9534f;">Logout</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBj_9a5ep2lxKru6yEQqNLHqpSZOm7qi-s",
  authDomain: "smart-phc-dashboard.firebaseapp.com",
  databaseURL: "https://smart-phc-dashboard-default-rtdb.firebaseio.com",
  projectId: "smart-phc-dashboard",
  storageBucket: "smart-phc-dashboard.firebasestorage.app",
  messagingSenderId: "519246980359",
  appId: "1:519246980359:web:80d2b1dec39076ad2ad1a2",
  measurementId: "G-QQX4EZK7KP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let medicineDataFull = [];
let medicineDataFiltered = [];
let currentDeduction = null;

window.login = async ()=>{ try{ await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value); }catch(e){ alert(e.message); } };
window.logout = ()=>{ signOut(auth); };
onAuthStateChanged(auth,(user)=>{ if(user){ loginSection.style.display="none"; dashboard.style.display="block"; loadDataFromCloud(); } else{ dashboard.style.display="none"; loginSection.style.display="block"; medicineDataFull=[]; medicineDataFiltered=[];}});

const unique=a=>[...new Set(a.map(v=>(v||"").trim()).filter(Boolean))];
function saveDataToCloud(){ set(ref(db,"medicineStock"), medicineDataFull); }
function loadDataFromCloud(){ get(child(ref(db),"medicineStock")).then(snap=>{
  medicineDataFull = snap.val()||[];
  applyFilters();
}); }

function toMMYYYY(s){ if(!s)return""; let p=new Date(s); if(!isNaN(p))return ("0"+(p.getMonth()+1)).slice(-2)+"/"+p.getFullYear(); return s; }
function getLastDateOfExpiryMonth(m){ if(!m)return null; let[mm,yy]=m.split("/"); return new Date(parseInt(yy),parseInt(mm),0); }
function getExpiryLabel(d){ if(d<0)return"Expired"; if(d===0)return"Expiring Today"; if(d<=30)return d+" days left"; if(d<=60)return Math.round(d/7)+" weeks"; if(d<=365)return"About "+Math.floor(d/30)+" months"; return"More than a year"; }

// Virtual Scrolling Settings
const ROW_HEIGHT = 40; // px height per row
const BUFFER_ROWS = 5;

const container = document.getElementById('virtualScrollContainer');
const tbody = document.getElementById('medicineTableBody');

function createRow(medicine) {
  const tr = document.createElement('tr');
  tr.style.height = ROW_HEIGHT + 'px';
  tr.innerHTML = `
    <td>${medicine["Medicine Name"]}</td>
    <td>${medicine.Rack || ''}</td>
    <td>${medicine.Quantity}</td>
    <td>${toMMYYYY(medicine["Expiry Date"])}</td>
  `;
  return tr;
}

function renderVirtualTable() {
  const totalRows = medicineDataFiltered.length;
  const visibleRowCount = Math.ceil(container.clientHeight / ROW_HEIGHT);
  const scrollTopIndex = Math.floor(container.scrollTop / ROW_HEIGHT);

  const startIndex = Math.max(0, scrollTopIndex - BUFFER_ROWS);
  const endIndex = Math.min(totalRows - 1, scrollTopIndex + visibleRowCount + BUFFER_ROWS);

  tbody.innerHTML = "";

  const paddingTop = startIndex * ROW_HEIGHT;
  const paddingBottom = (totalRows - endIndex - 1) * ROW_HEIGHT;

  const paddingTopRow = document.createElement('tr');
  paddingTopRow.style.height = paddingTop + 'px';
  paddingTopRow.style.border = 'none';
  tbody.appendChild(paddingTopRow);

  for(let i = startIndex; i <= endIndex; i++) {
    const row = createRow(medicineDataFiltered[i]);
    tbody.appendChild(row);
  }

  const paddingBottomRow = document.createElement('tr');
  paddingBottomRow.style.height = paddingBottom + 'px';
  paddingBottomRow.style.border = 'none';
  tbody.appendChild(paddingBottomRow);
}

container.addEventListener('scroll', renderVirtualTable);

function applyFilters() {
  const searchTerm = searchBox.value.toLowerCase();
  const rackFilterVal = rackFilter.value.toLowerCase();

  medicineDataFiltered = medicineDataFull.filter(med => {
    return (
      (!rackFilterVal || (med.Rack || '').toLowerCase() === rackFilterVal) &&
      (!searchTerm || (med["Medicine Name"] || '').toLowerCase().includes(searchTerm))
    );
  });

  renderVirtualTable();
}

// Update filters on input/select change
searchBox.addEventListener('input', applyFilters);
rackFilter.addEventListener('change', applyFilters);

// Replace existing renderTable functionality with filtering and virtual rendering
function renderTable() { applyFilters(); }

// Override loadDataFromCloud to set full data then filter and render
loadDataFromCloud = function (){
  get(child(ref(db), "medicineStock")).then(snap => {
    medicineDataFull = snap.val() || [];
    applyFilters();
    // Update rackFilter based on current data
    const racks = unique(medicineDataFull.map(m => m.Rack));
    rackFilter.innerHTML = "<option value=''>All Racks</option>" + racks.map(r => `<option>${r}</option>`).join('');
  });
};

// Other existing functions related to Excel and PDF imports remain unchanged
excelFile.onchange=()=>{ const f=excelFile.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); let d=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); d=d.map(m=>({...m,"Expiry Date":toMMYYYY(m["Expiry Date"])})); mergeStock(d); }; r.readAsArrayBuffer(f); };
pdfFile.onchange=()=>{ const f=pdfFile.files[0]; if(!f)return; const r=new FileReader(); r.onload=async function(){ const pdf=await pdfjsLib.getDocument({data:new Uint8Array(this.result)}).promise; let text=''; for(let p=1;p<=pdf.numPages;p++){const pg=await pdf.getPage(p); const tc=await pg.getTextContent(); text+=tc.items.map(i=>i.str).join(' ')+'\n';} let arr=[]; for(let line of text.split('\n')){let m=line.match(/([\w\s]+)\s+(\S+)\s+(\d+)/); if(m)arr.push({"Medicine Name":m[1].trim(),"Expiry Date":toMMYYYY(m[2]),"Quantity":+m[3],"Rack":""});} mergeStock(arr); }; r.readAsArrayBuffer(f); };

function mergeStock(newData){
  newData.forEach(n=>{
    let existing = medicineDataFull.find(o => o["Medicine Name"].toLowerCase() === n["Medicine Name"].toLowerCase() && o["Expiry Date"] === n["Expiry Date"]);
    if(existing){
      existing.Quantity += n.Quantity;
    } else {
      medicineDataFull.push(n);
    }
  });
  saveDataToCloud();
  applyFilters();
}

// Rest of your existing code including deduction, QR scanning, etc. remains unchanged and works as before

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart PHC Medicine Store Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- CDN Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background: #f5fdfc; margin: 0; color: #333; }
header { background: linear-gradient(90deg, #0077b6, #00b894); color: #fff; padding: 15px; text-align: center; font-size: 22px; font-weight: bold;}
nav { display: flex; background-color: #e3f6f5; border-bottom: 1px solid #ccc;}
nav button { flex: 1; padding: 12px; border: none; background: transparent; font-size: 16px; cursor: pointer;}
nav button.active { border-bottom: 3px solid #0077b6; font-weight: bold; color: #0077b6;}
.tab-content { display: none; padding: 20px;}
.tab-content.active { display: block;}
.alert { background: #ffeaa7; padding: 10px; margin-bottom: 15px; border-left: 5px solid #fdcb6e;}

.controls { display: flex; flex-wrap: wrap; gap: 18px; align-items: end; margin-bottom: 15px; }
.form-group { display: flex; flex-direction: column; }
.form-group label { color: #0077b6; font-size: 14px; margin-bottom: 4px; font-weight: 600; letter-spacing: 0.2px; display: flex; align-items: center; gap: 5px;}
input[type="file"], input[type="text"], select { border-radius: 8px; border: 1px solid #b0e2e0; padding: 6px 10px; font-size: 15px; background: #e3f6f5; transition: border 0.2s, box-shadow 0.2s;}
input[type="file"]:hover, input[type="text"]:hover, select:hover { border: 1.5px solid #00b894; box-shadow: 0 1px 3px rgba(0,0,0,0.08);}
.button-group { flex-direction: row; gap: 8px;}
button { border-radius: 8px; background: linear-gradient(90deg, #0077b6, #00b894); border: none; padding: 8px 14px; font-size: 14px; font-weight: 600; cursor: pointer; color: #fff; white-space: nowrap; }
button:hover { background: #00b894; }

table { width: 100%; border-collapse: collapse; background: #fff; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #d0f0ec; }
</style>
</head>
<body>

<header>üíä Smart PHC Medicine Store Dashboard</header>

<nav>
  <button class="tab-btn active" data-tab="stock">Medicine Stock</button>
  <button class="tab-btn" data-tab="nearExpiry">Near Expiry</button>
  <button class="tab-btn" data-tab="qr">QR Scanner</button>
  <button class="tab-btn" data-tab="reports">Reports</button>
</nav>

<!-- STOCK TAB -->
<div id="stock" class="tab-content active">
  <div class="alert" id="expiryAlert">No near-expiry medicines.</div>
  <div class="controls">
    <div class="form-group">
      <label for="excelFile">üì• Import Excel</label>
      <input type="file" id="excelFile" accept=".xlsx,.xls">
    </div>
    <div class="form-group">
      <label for="pdfFile">üìÑ Ack PDF</label>
      <input type="file" id="pdfFile" accept="application/pdf">
    </div>
    <div class="form-group">
      <label for="rackFilter">üóÑ Rack</label>
      <select id="rackFilter"><option value="">All Racks</option></select>
    </div>
    <div class="form-group">
      <label for="searchBox">üîç Search</label>
      <input type="text" id="searchBox" placeholder="Search medicine...">
    </div>
    <div class="form-group">
      <label for="expiryDaysStock">‚è≥ Near Expiry</label>
      <select id="expiryDaysStock">
        <option value="30">30 days</option>
        <option value="60">60 days</option>
        <option value="90">90 days</option>
        <option value="100">100 days</option>
      </select>
    </div>
    <div class="form-group button-group">
      <button onclick="exportExcel()">üìä Excel</button>
      <button onclick="exportPDF()">üìë PDF</button>
    </div>
  </div>
  <table id="medicineTable">
    <thead>
      <tr>
        <th>Medicine Name</th>
        <th>Rack</th>
        <th>Quantity</th>
        <th>Expiry Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- NEAR EXPIRY TAB -->
<div id="nearExpiry" class="tab-content">
  <h3>Near Expiry Medicines</h3>
  <div class="controls">
    <div class="form-group">
      <label for="expiryDaysNear">‚è≥ Show expiring within</label>
      <select id="expiryDaysNear">
        <option value="30">30 days</option>
        <option value="60">60 days</option>
        <option value="90">90 days</option>
        <option value="100">100 days</option>
      </select>
    </div>
    <div class="form-group button-group">
      <button onclick="renderNearExpiry()">üîÑ Refresh</button>
      <button onclick="exportNearExpiryExcel()">üìä Excel</button>
      <button onclick="exportNearExpiryPDF()">üìë PDF</button>
    </div>
  </div>
  <table id="nearExpiryTable">
    <thead>
      <tr>
        <th>Medicine Name</th>
        <th>Rack</th>
        <th>Quantity</th>
        <th>Expiry Date</th>
        <th>Days Left</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- QR SCANNER TAB -->
<div id="qr" class="tab-content">
  <button onclick="startQRScanner()">Start Camera Scan</button>
  <div id="qr-reader" style="width:300px; margin-top:15px;"></div>
  <p>Scanned Result: <span id="qrResult"></span></p>
</div>

<!-- REPORTS TAB -->
<div id="reports" class="tab-content">
  <h3>Reports</h3>
  <p>View and download stock & expiry reports.</p>
</div>

<script>
let medicineData = [];
const unique = arr => Array.from(new Set(arr));

// Tab switching
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
    if (btn.dataset.tab === "nearExpiry") renderNearExpiry();
  });
});

// Excel upload
document.getElementById("excelFile").addEventListener("change", function(){
  const file = this.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      let newData = XLSX.utils.sheet_to_json(sheet);
      medicineData = mergeStock(medicineData, newData);
      renderTable(); checkExpiry();
    };
    reader.readAsArrayBuffer(file);
  }
});

// PDF processing
async function processPDF(){
  const input = document.getElementById('pdfFile');
  if(!input.files.length){ alert('Select a PDF first'); return; }
  const reader = new FileReader();
  reader.onload = async function(){
    const typedarray = new Uint8Array(this.result);
    const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
    let allText = '';
    for(let i=1;i<=pdf.numPages;i++){
      const page = await pdf.getPage(i);
      const txt = await page.getTextContent();
      allText += txt.items.map(it => it.str).join(' ') + '\n';
    }
    parsePDFData(allText);
  };
  reader.readAsArrayBuffer(input.files[0]);
}

function parsePDFData(text){
  let lines = text.split('\n'), newData = [];
  for(let line of lines){
    let m = line.match(/([A-Za-z0-9\s]+)\s+(\d{2}\/\d{4})\s+(\d+)/);
    if(m){
      newData.push({"Medicine Name": m[1].trim(),"Expiry Date": m[2].trim(),"Quantity": parseInt(m[3]),"Rack":""});
    }
  }
  if(newData.length){ medicineData = mergeStock(medicineData, newData); renderTable(); checkExpiry(); alert("PDF imported!"); }
  else alert("No medicines found in PDF. Adjust parsing as needed.");
}

function mergeStock(existing, incoming){
  for(let item of incoming){
    let found = existing.find(e => e["Medicine Name"].toLowerCase() === item["Medicine Name"].toLowerCase() && e["Expiry Date"] === item["Expiry Date"]);
    if(found) found.Quantity += item.Quantity; else existing.push(item);
  }
  return existing;
}

function renderTable(){
  const tbody = document.querySelector("#medicineTable tbody"); tbody.innerHTML = "";
  let rack = document.getElementById("rackFilter").value.toLowerCase();
  let search = document.getElementById("searchBox").value.toLowerCase();
  let racks = unique(medicineData.map(m => m.Rack).filter(r => r));
  let rackSelect = document.getElementById("rackFilter");
  rackSelect.innerHTML = "<option value=''>All Racks</option>"; racks.forEach(r => rackSelect.innerHTML += `<option value="${r}">${r}</option>`);
  let sorted = [...medicineData].sort((a,b)=> new Date(a["Expiry Date"]) - new Date(b["Expiry Date"]));
  sorted.forEach(row=>{
    if ((rack && row.Rack?.toLowerCase() !== rack) || (search && !row["Medicine Name"].toLowerCase().includes(search))) return;
    tbody.innerHTML += `<tr><td>${row["Medicine Name"]}</td><td>${row.Rack||""}</td><td>${row.Quantity}</td><td>${row["Expiry Date"]}</td></tr>`;
  });
}

document.getElementById("rackFilter").addEventListener("change", renderTable);
document.getElementById("searchBox").addEventListener("input", renderTable);

function checkExpiry(){
  let threshold = parseInt(document.getElementById("expiryDaysStock").value);
  let today = new Date();
  let nearExpiry = medicineData.filter(m => {
    let diff = (new Date(m["Expiry Date"]) - today)/(1000*60*60*24);
    return diff <= threshold && diff >= 0;
  });
  document.getElementById("expiryAlert").innerHTML = nearExpiry.length ? `‚ö† ${nearExpiry.length} batches expiring within ${threshold} days!` : `No medicines expiring within ${threshold} days.`;
}
document.getElementById("expiryDaysStock").addEventListener("change", checkExpiry);

function exportExcel(){ const ws = XLSX.utils.json_to_sheet(medicineData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Stock"); XLSX.writeFile(wb, "medicine_stock.xlsx"); }
function exportPDF(){ html2pdf().from(document.getElementById("medicineTable")).save("medicine_stock.pdf"); }

// Near Expiry Tab functions
function renderNearExpiry(){
  let days = parseInt(document.getElementById("expiryDaysNear").value), today = new Date();
  let list = medicineData.map(m => ({...m, daysLeft: Math.ceil((new Date(m["Expiry Date"]) - today)/(1000*60*60*24))}))
              .filter(m => m.daysLeft <= days && m.daysLeft >= 0)
              .sort((a,b)=>a.daysLeft - b.daysLeft);
  const tbody = document.querySelector("#nearExpiryTable tbody"); tbody.innerHTML = "";
  list.forEach(row=>{ tbody.innerHTML += `<tr><td>${row["Medicine Name"]}</td><td>${row.Rack||""}</td><td>${row.Quantity}</td><td>${row["Expiry Date"]}</td><td>${row.daysLeft}</td></tr>`; });
}
function exportNearExpiryExcel(){ let days = parseInt(document.getElementById("expiryDaysNear").value), today=new Date();
  let list = medicineData.map(m=>({...m, daysLeft: Math.ceil((new Date(m["Expiry Date"]) - today)/(1000*60*60*24))})).filter(m=>m.daysLeft<=days && m.daysLeft>=0).sort((a,b)=>a.daysLeft-b.daysLeft);
  const ws = XLSX.utils.json_to_sheet(list); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Near Expiry"); XLSX.writeFile(wb,"near_expiry.xlsx"); }
function exportNearExpiryPDF(){ html2pdf().from(document.getElementById("nearExpiryTable")).save("near_expiry.pdf"); }
document.getElementById("expiryDaysNear").addEventListener("change", renderNearExpiry);

// QR Scanner
function startQRScanner(){
  const qrReader = new Html5Qrcode("qr-reader");
  qrReader.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    msg => { document.getElementById("qrResult").textContent = msg; qrReader.stop(); });
}
</script>
</body>
</html>
